# =========================================================================
# [EN] Trajectory visualization for B=1.60T, beam angle=4.0 deg
# [CN] 轨迹可视化: B=1.60T, 束流偏转角=4.0度
# =========================================================================
# [EN] Uses /control/loop to shoot 3 tracks in sequence:
#      1. Deuteron (380 MeV from upstream)
#      2. Proton Py=+100 MeV/c (AngleX=-9.07 deg)
#      3. Proton Py=-100 MeV/c (AngleX=+9.07 deg)
# [CN] 使用 /control/loop 依次发射3条轨迹:
#      1. 氘核 (380 MeV 从上游)
#      2. 质子 Py=+100 MeV/c (AngleX=-9.07度)
#      3. 质子 Py=-100 MeV/c (AngleX=+9.07度)
# =========================================================================
# Target position: X=-152.7034mm, Y=0.0283mm, Z=-1571.5049mm
# =========================================================================

# 1. Open visualization
/vis/open OGLIQt 1280x720

# 2. Load Geometry - B=1.60T
/control/execute /home/tian/workspace/dpol/smsimulator5.5/configs/simulation/DbeamTest/trajectory_viz/geometry_B160T.mac

/action/file/OverWrite y
/action/file/RunName trajectory_B160T_4.0deg
/action/file/SaveDirectory /home/tian/workspace/dpol/smsimulator5.5/data/simulation/g4output

# 3. Draw volume FIRST (required before adding scene elements)
/vis/drawVolume

# 4. Set Z-X plane view (top view)
/vis/viewer/set/upVector 1 0 0
/vis/viewer/set/viewpointThetaPhi 90. 90.

# 5. Add coordinate axes
/vis/scene/add/axes 0 0 0 6000 mm

# ==========================================
# [CRITICAL] Trajectory settings - BEFORE beamOn
# [EN] Must configure trajectory visualization before any beamOn
# [CN] 必须在任何 beamOn 之前配置轨迹可视化
# ==========================================
/vis/scene/add/trajectories smooth
/vis/modeling/trajectories/create/drawByCharge
/vis/modeling/trajectories/drawByCharge-0/default/setDrawStepPts true
/vis/modeling/trajectories/drawByCharge-0/default/setStepPtsSize 2
/vis/scene/endOfEventAction accumulate
/vis/scene/endOfRunAction accumulate

# Disable auto refresh during shooting
/vis/viewer/set/autoRefresh false
/vis/verbose warnings

# ==========================================
# [EN] Shoot 3 tracks using /control/loop
# [CN] 使用 /control/loop 发射3条轨迹
# ==========================================
# [EN] /control/loop iterates over particle list and executes macro for each
# [CN] /control/loop 遍历粒子列表，为每个粒子执行宏
/action/gun/Type Pencil

/control/loop /home/tian/workspace/dpol/smsimulator5.5/configs/simulation/DbeamTest/trajectory_viz/shoot_3tracks_B160T.mac TRACK 1 3 1

# ==========================================
# Refresh and Export
# ==========================================
/vis/viewer/set/autoRefresh true
/vis/viewer/refresh
/vis/viewer/update
/vis/viewer/zoomTo 0.3

# Export: /vis/ogl/export trajectory_B160T_4.0deg.png
# Vector: /vis/ogl/printEPS
