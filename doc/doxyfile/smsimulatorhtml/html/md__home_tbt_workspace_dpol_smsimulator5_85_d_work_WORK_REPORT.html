<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>smg4lib: 工作汇报 — 仓库修改摘要</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">smg4lib
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">工作汇报 — 仓库修改摘要 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>本文档简短记录在本仓库（smsimulator5.5）中你（或我们）所做的代码与脚本修改、目的、验证步骤以及后续建议。放在：<code>/home/tbt/workspace/dpol/smsimulator5.<a class="el" href="WORK__REPORT_8md.html">5/d_work/WORK_REPORT.md</a></code>。</p>
<h1><a class="anchor" id="autotoc_md31"></a>
关键变更清单（Checklist）</h1>
<ul>
<li>[x] 修复 <code>vis.mac</code>：将 <code>/action/gun/tree/beamOn</code> 明确为带事件数（例如 <code>... beamOn 9</code>），避免命令解析异常。</li>
<li>[x] 修复 <code><a class="el" href="classPrimaryGeneratorActionBasic.html#a008559d3634d6c8c36f34b34bbaaf1ab">PrimaryGeneratorActionBasic::TreeBeamOn</a></code>：移除末尾 <code>fRootInputFile-&gt;Close();</code>，保持输入 <a class="el" href="namespaceROOT.html">ROOT</a> 文件在交互式会话中打开，从而允许多次调用 <code>/action/gun/tree/beamOn</code>。</li>
<li>[x] 修复 NEBULA converter 的空指针访问（先前会话中修改）：为 <code>NEBULASimDataConverter_TArtNEBULAPla.cc</code> 添加空检查并延后 placement-new，减少 <code>TArtDataObject::Copy</code> 导致的 segfault 风险。</li>
<li>[x] 新增/更新用于调试和查看的数据/宏：<code><a class="el" href="data__flow__README_8md.html">d_work/macros/dpol/data_flow_README.md</a></code>（数据流说明）和 <code>d_work/macros/dpol/reconstruction/reconstruct_one_event.cc</code>（示例 <a class="el" href="namespaceROOT.html">ROOT</a> 宏，用于查看 PDC/NEBULA 信息）。</li>
</ul>
<h1><a class="anchor" id="autotoc_md32"></a>
具体修改（文件与要点）</h1>
<ul>
<li><code>d_work/vis.mac</code><ul>
<li>将 <code>/action/gun/tree/beamOn</code> 改为 <code>/action/gun/tree/beamOn 9</code>（或其他期望的事件数）。</li>
<li>目的：在可视化交互场景中显式指定从输入树发射的事件数，避免解析问题。</li>
</ul>
</li>
<li><code>smg4lib/action/src/PrimaryGeneratorActionBasic.cc</code><ul>
<li>在 <code>TreeBeamOn(G4int num)</code> 末尾移除了 <code>fRootInputFile-&gt;Close();</code>。</li>
<li>添加注释：避免在交互式会话中第二次调用 <code>/action/gun/tree/beamOn</code> 时访问已关闭的分支导致崩溃。</li>
<li>影响：允许在同一进程内多次运行 Tree 输入；输入文件将在程序退出时自动关闭。</li>
</ul>
</li>
<li><code>smg4lib/data/sources/src/NEBULASimDataConverter_TArtNEBULAPla.cc</code>（先前修改）<ul>
<li>为 <code>NEBULAParameter</code> 与 detector parameter (<code>prm</code>) 添加空指针检查；如果缺失则记录警告并跳过该 ID；将对 <code>TArtNEBULAPla</code> 的 placement-new 移到参数校验之后。</li>
<li>目的：防止在转换阶段因未初始化/缺失参数导致的未定义行为与段错误。</li>
</ul>
</li>
<li><code><a class="el" href="data__flow__README_8md.html">d_work/macros/dpol/data_flow_README.md</a></code><ul>
<li>新增：描述从敏感探测器 → <code>TClonesArray</code> → converter → <code>TTree</code> 的完整数据流、关键文件和调试要点。</li>
</ul>
</li>
<li><code>d_work/macros/dpol/reconstruction/reconstruct_one_event.cc</code><ul>
<li>新增/修改：示例 <a class="el" href="namespaceROOT.html">ROOT</a> 宏，能够打开 <code>output_tree/test0000.root</code> 并打印 PDC（FragSimData）与 NEBULA（TArtNEBULAPla）信息；为了兼容缺失头文件，部分读取逻辑使用运行时 RTTI/Print()。</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md33"></a>
为什么要做这些改动（简短说明）</h1>
<ul>
<li>在交互式可视化场景中，用户可能重复触发 Tree 输入。原实现运行后立即关闭输入文件，会造成第二次调用时访问到已释放或失效的分支/缓冲，从而引发段错误。移除即时关闭并显式在宏中传入事件数可以避免这类错误。</li>
<li>converter 的空检查可防止对不存在的 detector parameter 解引用，修复了观察到的 gdb backtrace 指向 <code>TArtDataObject::Copy</code> 的崩溃点。</li>
</ul>
<h1><a class="anchor" id="autotoc_md34"></a>
编译与验证步骤（建议）</h1>
<ol type="1">
<li>设置环境（如果项目有 setup 脚本）： <div class="fragment"><div class="line">. ./setup.sh</div>
</div><!-- fragment --></li>
<li>重新编译受影响模块： <div class="fragment"><div class="line">cd smg4lib &amp;&amp; make -j4</div>
<div class="line">cd ../sim_deuteron &amp;&amp; make -j4</div>
</div><!-- fragment --></li>
<li>验证 Tree 输入在交互会话中可重复调用： <div class="fragment"><div class="line"># 带可视化的宏</div>
<div class="line">../bin/sim_deuteron d_work/vis.mac</div>
<div class="line"># 或者在 Geant4 UI 中手动执行：</div>
<div class="line">/action/gun/tree/beamOn 1</div>
<div class="line"># 等完成后再次执行</div>
<div class="line">/action/gun/tree/beamOn 1</div>
</div><!-- fragment --><ul>
<li>期望：不会在第二次执行时发生 segmentation fault。</li>
</ul>
</li>
<li>若仍崩溃：用 gdb 运行并抓取 backtrace： <div class="fragment"><div class="line">gdb --args ../bin/sim_deuteron d_work/vis.mac</div>
<div class="line"># 在 gdb 中 run，崩溃后输入 bt full</div>
</div><!-- fragment --></li>
</ol>
<p>把 backtrace 发来以便进一步定位。</p>
<h1><a class="anchor" id="autotoc_md35"></a>
推荐的 Git commit 信息（示例）</h1>
<ul>
<li>Commit 标题（简短）： fix(action): keep Tree input TFile open after TreeBeamOn to allow repeated calls</li>
<li>Commit 详细信息（正文）： Keep the input <a class="el" href="namespaceROOT.html">ROOT</a> file open after executing <code><a class="el" href="classPrimaryGeneratorActionBasic.html#a008559d3634d6c8c36f34b34bbaaf1ab">PrimaryGeneratorActionBasic::TreeBeamOn</a></code>. Previously the function closed <code>fRootInputFile</code> at the end of the run, which caused subsequent interactive calls to <code>/action/gun/tree/beamOn</code> to access a closed file/branch and crash (segmentation fault). Removing the immediate close allows multiple TreeBeamOn invocations in the same process. The file will be closed automatically on program exit.</li>
<li>Git 命令示例： <div class="fragment"><div class="line">git add smg4lib/action/src/PrimaryGeneratorActionBasic.cc</div>
<div class="line">git commit -m &quot;fix(action): keep Tree input TFile open after TreeBeamOn to allow repeated calls&quot; -m $&#39;Keep the input ROOT file open after executing PrimaryGeneratorActionBasic::TreeBeamOn.\n\nPreviously the function closed fRootInputFile at the end of the run, which caused subsequent interactive calls to /action/gun/tree/beamOn to access a closed file/branch and crash (segmentation fault). Removing the immediate close allows multiple TreeBeamOn invocations in the same process. The file will be closed automatically on program exit.\n\nTesting:\n- Rebuild smg4lib and sim_deuteron.\n- Start interactive/visual session and run /action/gun/tree/beamOn 1 twice; no crash should occur.\n&#39;</div>
<div class="line"> </div>
<div class="line">git push origin main</div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md36"></a>
下一步建议</h1>
<ul>
<li>在 CI 或本地做一次完整的短跑（10&ndash;50 事件），同时开启与关闭可视化，确认不会复现 segfault；若出现，收集 gdb backtrace 后继续修复。</li>
<li>考虑在 <code><a class="el" href="classPrimaryGeneratorActionBasic.html">PrimaryGeneratorActionBasic</a></code> 中加入一个专门的 <code>CloseInputTree</code> 方法，由用户在确实不再使用输入时显式调用，而不是在 <code>TreeBeamOn</code> 内隐式关闭。</li>
<li>若需要把 <code>TFragSimData.hh</code> 等头文件暴露给用户宏以便更丰富的分析，可以把相应头文件路径添加到 <code>d_work</code> 的宏 include 路径或 copy 一份到 <code>d_work/include</code>。</li>
</ul>
<hr  />
<p> 若你希望我把此报告 commit 到仓库（并同时提交相关变更），我可以为你执行 <code>git add</code>/<code>git commit</code> 并给出最终提交哈希；或者把报告内容做成更完整的 PR 描述。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
